---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import ThemeToggle from '../../components/ThemeToggle.astro';

export async function getStaticPaths() {
  const recipes = await getCollection('dishes');
  return recipes.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const baseUrl = import.meta.env.BASE_URL;

// Image Logic: Prioritize local markdown images (likely valid) over frontmatter external links (often broken/page links)
function getImagesFromBody(body) {
  const mdMatches = [...body.matchAll(/!\[.*?\]\((.*?)\)/g)].map(m => m[1]);
  const htmlMatches = [...body.matchAll(/<img.*?src=["'](.*?)["']/g)].map(m => m[1]);
  return [...mdMatches, ...htmlMatches].filter(url => !url.endsWith('.svg'));
}

const bodyImages = getImagesFromBody(entry.body);
let heroImage;

if (bodyImages.length > 0) {
  // User Request: Pick one randomly from available images
  heroImage = bodyImages[Math.floor(Math.random() * bodyImages.length)];
} else {
  // Fallback to frontmatter or placeholder
  const imageArray = entry.data.images || [];
  heroImage = (imageArray.length > 0 ? imageArray[0].url : null) || `${baseUrl}/images/cover_collage.png`;
}

// Extract Metadata
const {
  region,
  original_name,
  difficulty,
  prep_time,
  cook_time,
  servings,
  nutrition,
  tags
} = entry.data;

const schema = {
  "@context": "https://schema.org",
  "@type": "Recipe",
  "name": entry.data.title,
  "headline": entry.data.title,
  "image": heroImage,
  "recipeYield": servings,
  "prepTime": prep_time,
  "cookTime": cook_time,
  "nutrition": nutrition ? {
    "@type": "NutritionInformation",
    "calories": nutrition.calories,
    "carbohydrateContent": nutrition.carbs,
    "proteinContent": nutrition.protein,
    "fatContent": nutrition.fat
  } : undefined,
  "url": new URL(Astro.url.pathname, Astro.site).toString(),
  "description": `Receta de ${entry.data.title} - AI Chef`
};
---
<script type="application/ld+json" set:html={JSON.stringify(schema)} />

<Layout title={entry.data.title || entry.slug}>
  <div class="min-h-screen w-full bg-[#fcfcfc] dark:bg-[#0a0a0a] font-sans selection:bg-primary selection:text-black">

    <!-- Scroll Progress Bar -->
    <div id="scroll-progress" class="fixed top-0 left-0 z-[60] h-1 bg-gradient-to-r from-primary via-orange-500 to-yellow-500 w-0 transition-all duration-100 ease-out"></div>

    <!-- Navbar -->
    <header class="sticky top-0 z-50 w-full glass-panel border-b border-black/5 dark:border-white/5 backdrop-blur-md bg-white/70 dark:bg-black/70 print:hidden">
      <div class="mx-auto flex h-16 max-w-7xl items-center justify-between px-4 sm:px-6 lg:px-8">
        <div class="flex items-center gap-4">
          <a href={baseUrl} class="flex size-10 items-center justify-center rounded-full bg-white dark:bg-[#1e1e1e] text-gray-700 dark:text-gray-200 hover:bg-primary hover:text-black hover:scale-105 transition-all shadow-sm ring-1 ring-black/5">
            <span class="material-symbols-outlined">arrow_back</span>
          </a>
          <div class="hidden sm:flex flex-col">
              <span class="text-[10px] font-black tracking-widest text-primary uppercase">AI Chef Protocol</span>
              <span class="text-xs font-mono text-gray-400 dark:text-gray-500 uppercase tracking-widest">ID: {entry.slug.split('/').pop()}</span>
          </div>
        </div>
        <div class="flex items-center gap-3">
            <button id="share-btn" class="hidden sm:flex size-10 items-center justify-center rounded-full bg-white dark:bg-[#1e1e1e] text-gray-400 dark:text-gray-500 hover:text-blue-500 hover:bg-blue-50 dark:hover:bg-blue-900/10 transition-all shadow-sm ring-1 ring-black/5" aria-label="Share Recipe">
               <span class="material-symbols-outlined text-[20px]">share</span>
            </button>
            <button id="print-btn" class="hidden sm:flex size-10 items-center justify-center rounded-full bg-white dark:bg-[#1e1e1e] text-gray-400 dark:text-gray-500 hover:text-green-500 hover:bg-green-50 dark:hover:bg-green-900/10 transition-all shadow-sm ring-1 ring-black/5" aria-label="Print Recipe">
               <span class="material-symbols-outlined text-[20px]">print</span>
            </button>
            <div class="w-px h-6 bg-gray-200 dark:bg-gray-700 mx-1"></div>
            <button id="fav-btn" class="group flex size-10 items-center justify-center rounded-full bg-white dark:bg-[#1e1e1e] text-gray-400 dark:text-gray-500 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 transition-all shadow-sm ring-1 ring-black/5" aria-label="Toggle Favorite">
              <span class="material-symbols-outlined transition-transform group-active:scale-90" id="fav-icon">favorite_border</span>
            </button>
            <ThemeToggle />
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-12 sm:px-6 lg:px-8">

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">

        <!-- LEFT COLUMN: Sticky Sidebar -->
        <div class="lg:col-span-4 xl:col-span-3">
            <div class="sticky top-24 space-y-8 animate-fade-in-up">

                <!-- 1. Dish Card -->
                <div class="group relative aspect-[3/4] w-full overflow-hidden rounded-3xl shadow-2xl ring-1 ring-black/5 dark:ring-white/10 bg-gray-100 dark:bg-gray-800">
                    <img
                      src={heroImage}
                      alt={entry.data.title}
                      class="absolute inset-0 h-full w-full object-cover transition-transform duration-1000 group-hover:scale-110"
                    />
                    <div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent opacity-80 group-hover:opacity-90 transition-opacity"></div>

                    <!-- Badges -->
                    <div class="absolute top-4 left-4 flex gap-2">
                        {region && <span class="backdrop-blur-md bg-white/20 border border-white/30 px-3 py-1 text-xs font-bold text-white uppercase tracking-wider rounded-full shadow-sm">{region}</span>}
                    </div>
                    <div class="absolute top-4 right-4">
                        <span class="material-symbols-outlined text-blue-400 drop-shadow-lg" title="AI Verified">verified</span>
                    </div>

                    <!-- Title Overlay -->
                    <div class="absolute bottom-6 left-6 right-6 text-white">
                        <div class="flex justify-between items-end">
                             <div class="flex-1">
                                <h3 class="text-2xl font-black font-display text-white leading-tight mb-1 shadow-black drop-shadow-md">{entry.data.title}</h3>
                                {original_name && <p class="text-white/80 text-sm italic font-serif">{original_name}</p>}
                             </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Nutrition (Grid) -->
                {nutrition && (
                <div class="rounded-3xl bg-white dark:bg-[#18181b] p-6 shadow-xl shadow-gray-200/50 dark:shadow-none ring-1 ring-black/5 dark:ring-white/5">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6 flex items-center gap-2">
                       <span class="material-symbols-outlined text-lg text-green-500">local_fire_department</span> Energy
                    </h4>
                    <div class="grid grid-cols-2 gap-4">
                       <div class="p-4 rounded-2xl bg-gray-50 dark:bg-white/5 text-center transition-colors hover:bg-gray-100 dark:hover:bg-white/10">
                          <span class="block text-2xl font-black text-gray-900 dark:text-white">{nutrition.calories}</span>
                          <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Kcal</span>
                       </div>
                       <div class="p-4 rounded-2xl bg-gray-50 dark:bg-white/5 text-center transition-colors hover:bg-gray-100 dark:hover:bg-white/10">
                          <span class="block text-2xl font-black text-gray-900 dark:text-white">{nutrition.protein}</span>
                          <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Protein</span>
                       </div>
                       <div class="p-4 rounded-2xl bg-gray-50 dark:bg-white/5 text-center transition-colors hover:bg-gray-100 dark:hover:bg-white/10">
                          <span class="block text-2xl font-black text-gray-900 dark:text-white">{nutrition.fat}</span>
                          <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Fat</span>
                       </div>
                       <div class="p-4 rounded-2xl bg-gray-50 dark:bg-white/5 text-center transition-colors hover:bg-gray-100 dark:hover:bg-white/10">
                          <span class="block text-2xl font-black text-gray-900 dark:text-white">{nutrition.carbs}</span>
                          <span class="text-[10px] uppercase font-bold text-gray-400 tracking-wider">Carbs</span>
                       </div>
                    </div>
                </div>
                )}
            </div>
        </div>

        <!-- RIGHT COLUMN: Main Content -->
        <div class="lg:col-span-8 xl:col-span-9 animate-fade-in-up" style="animation-delay: 0.1s;">
            <div class="rounded-[2.5rem] bg-white dark:bg-[#18181b] p-8 md:p-16 shadow-2xl shadow-gray-200/50 dark:shadow-none ring-1 ring-black/5 dark:ring-white/5 relative">

               <!-- Mobile Header (Visible only on small screens) -->
               <div class="lg:hidden mb-8">
                  <h1 class="font-display text-4xl font-black text-gray-900 dark:text-white leading-tight">{entry.data.title}</h1>
               </div>

               <!-- Metadata Header -->
               <div class="flex flex-wrap items-center gap-4 mb-12 text-sm text-gray-500 border-b border-gray-100 dark:border-white/10 pb-8">
                  <div class="flex items-center gap-1">
                     <span class="material-symbols-outlined text-yellow-400">star</span>
                     <span class="font-bold text-gray-900 dark:text-white">{difficulty || "Easy"}</span>
                  </div>
                  <div class="w-1 h-1 rounded-full bg-gray-300"></div>
                  <div>
                    {tags && tags.slice(0, 3).map((tag, i) => (
                        <span class="mr-2">#{tag}</span>
                    ))}
                  </div>
               </div>

               <!-- Process Timeline (New Horizontal) -->
               <div class="mb-12 rounded-3xl bg-gray-50 dark:bg-white/5 p-6 ring-1 ring-black/5 dark:ring-white/5">
                    <h4 class="text-xs font-bold uppercase tracking-widest text-gray-400 mb-6 flex items-center gap-2">
                       <span class="material-symbols-outlined text-lg text-primary">schedule</span> Process Timeline
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 relative">
                        <!-- Horizontal connecting line (Desktop only) -->
                        <div class="hidden md:block absolute top-1/2 left-10 right-10 h-0.5 bg-gradient-to-r from-blue-500 via-orange-500 to-green-500 opacity-20 -translate-y-1/2"></div>

                        <!-- Prep -->
                        <div class="relative flex flex-col items-center text-center group">
                            <div class="z-10 flex size-12 shrink-0 items-center justify-center rounded-full bg-blue-50 dark:bg-blue-900/30 ring-4 ring-white dark:ring-[#18181b] group-hover:scale-110 transition-transform mb-3">
                                <span class="material-symbols-outlined text-blue-500">kitchen</span>
                            </div>
                            <div>
                                <span class="block text-[10px] font-bold text-blue-500 uppercase tracking-widest mb-0.5">Prep</span>
                                <span class="block text-lg font-bold text-gray-900 dark:text-gray-100">{prep_time || "--"}</span>
                            </div>
                        </div>

                        <!-- Cook -->
                        <div class="relative flex flex-col items-center text-center group">
                            <div class="z-10 flex size-12 shrink-0 items-center justify-center rounded-full bg-orange-50 dark:bg-orange-900/30 ring-4 ring-white dark:ring-[#18181b] group-hover:scale-110 transition-transform mb-3">
                                <span class="material-symbols-outlined text-orange-500">skillet</span>
                            </div>
                            <div>
                                <span class="block text-[10px] font-bold text-orange-500 uppercase tracking-widest mb-0.5">Cook</span>
                                <span class="block text-lg font-bold text-gray-900 dark:text-gray-100">{cook_time || "--"}</span>
                            </div>
                        </div>

                        <!-- Yield -->
                         <div class="relative flex flex-col items-center text-center group">
                            <div class="z-10 flex size-12 shrink-0 items-center justify-center rounded-full bg-green-50 dark:bg-green-900/30 ring-4 ring-white dark:ring-[#18181b] group-hover:scale-110 transition-transform mb-3">
                                <span class="material-symbols-outlined text-green-500">restaurant</span>
                            </div>
                            <div>
                                <span class="block text-[10px] font-bold text-green-500 uppercase tracking-widest mb-0.5">Yield</span>
                                <span class="block text-lg font-bold text-gray-900 dark:text-gray-100">{servings || "--"} P</span>
                            </div>
                        </div>
                    </div>
                </div>

               <!-- Markdown Content with Enhanced Typography -->
               <article class="prose prose-lg md:prose-xl max-w-none
                  prose-headings:font-display prose-headings:font-bold prose-headings:text-gray-900 dark:prose-headings:text-white
                  prose-p:text-gray-600 dark:prose-p:text-gray-300 prose-p:leading-loose
                  prose-li:text-gray-600 dark:prose-li:text-gray-300
                  prose-img:rounded-3xl prose-img:shadow-xl prose-img:mx-auto prose-img:my-10 prose-img:ring-1 prose-img:ring-black/5
                  prose-strong:text-gray-900 dark:prose-strong:text-white prose-strong:font-black
                  marker:text-primary prose-blockquote:border-l-4 prose-blockquote:border-primary prose-blockquote:pl-6 prose-blockquote:italic

                  /* Custom Lists Styling via CSS targeting */
                  [&_ul]:list-none [&_ul]:pl-0 [&_ul]:space-y-4
                  [&_ul_li]:relative [&_ul_li]:pl-8
                  [&_ul_li]:before:content-[''] [&_ul_li]:before:absolute [&_ul_li]:before:left-0 [&_ul_li]:before:top-[0.6em] [&_ul_li]:before:size-2.5 [&_ul_li]:before:bg-primary [&_ul_li]:before:rounded-full [&_ul_li]:before:shadow-[0_0_10px_rgba(255,99,71,0.5)]

                   /* Custom Ordered Lists Styling (Stepper with Animations) - Applied via JS */
                   [&_ol]:list-none [&_ol]:[counter-reset:step] [&_ol]:space-y-0 [&_ol]:relative [&_ol]:recipe-steps-list
                   /* Continuous line - animated */
                   [&_ol]:before:content-[''] [&_ol]:before:absolute [&_ol]:before:left-[15px] [&_ol]:before:top-4 [&_ol]:before:bottom-0 [&_ol]:before:w-0.5 [&_ol]:before:bg-gradient-to-b [&_ol]:before:from-primary [&_ol]:before:via-orange-400 [&_ol]:before:to-green-400 [&_ol]:before:opacity-30
                   [&_ol]:after:content-[''] [&_ol]:after:absolute [&_ol]:after:left-[15px] [&_ol]:after:top-4 [&_ol]:after:w-0.5 [&_ol]:after:bg-gradient-to-b [&_ol]:after:from-primary [&_ol]:after:via-orange-400 [&_ol]:after:to-green-400 [&_ol]:after:h-0 [&_ol]:after:transition-all [&_ol]:after:duration-1000 [&_ol]:after:ease-out

                   [&_ol_li]:relative [&_ol_li]:pl-16 [&_ol_li]:pb-12 [&_ol_li]:[counter-increment:step] [&_ol_li]:recipe-step
                   /* Opacity handled by JS class .step-waiting to ensure visibility fallback */
                   [&_ol_li]:last-child:pb-0

                   /* Step Circle with animations */
                   [&_ol_li]:before:content-[counter(step)] [&_ol_li]:before:absolute [&_ol_li]:before:left-0 [&_ol_li]:before:top-0 [&_ol_li]:before:z-10 [&_ol_li]:before:flex [&_ol_li]:before:size-8 [&_ol_li]:before:items-center [&_ol_li]:before:justify-center [&_ol_li]:before:rounded-full [&_ol_li]:before:bg-gray-300 dark:[&_ol_li]:before:bg-gray-600 [&_ol_li]:before:text-white [&_ol_li]:before:font-black [&_ol_li]:before:text-sm [&_ol_li]:before:shadow-lg [&_ol_li]:before:ring-4 [&_ol_li]:before:ring-white dark:[&_ol_li]:before:ring-[#18181b] [&_ol_li]:before:transition-all [&_ol_li]:before:duration-500 [&_ol_li]:before:cursor-pointer

                   /* Hover effects on steps */
                   [&_ol_li]:hover:before:scale-110 [&_ol_li]:hover:before:shadow-xl [&_ol_li]:hover:before:shadow-primary/30

                  /* Headings */
                  [&_h2]:text-3xl [&_h2]:mt-12 [&_h2]:mb-8 [&_h2]:flex [&_h2]:items-center [&_h2]:gap-3
                  [&_h2]:after:content-[''] [&_h2]:after:h-1 [&_h2]:after:flex-1 [&_h2]:after:bg-gray-100 dark:[&_h2]:after:bg-white/5 [&_h2]:after:rounded-full
                  ">
                  <Content />
               </article>

            </div>
        </div>

      </div>
    </main>
  </div>

  <style>
      .animate-fade-in-up {
          animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
          opacity: 0;
          transform: translateY(20px);
      }
      @keyframes fadeInUp {
          to {
              opacity: 1;
              transform: translateY(0);
          }
      }

      /* Recipe Stepper Animations */
      /* Base state for steps managed by JS to avoid invisibility issues */
      .step-waiting {
          opacity: 0;
          transform: translateY(20px);
      }

      .step-visible {
          opacity: 1 !important;
          transform: translateY(0) !important;
          transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      }

      .step-completed::before {
          background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%) !important;
          box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4) !important;
          animation: stepComplete 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
          content: 'âœ“'; /* Add checkmark directly implies completed */
      }

      .step-active::before {
          background: linear-gradient(135deg, #f97316 0%, #ea580c 100%) !important;
          box-shadow: 0 4px 25px rgba(249, 115, 22, 0.5) !important;
          animation: stepPulse 2s ease-in-out infinite;
      }

      .step-pending::before {
          background: linear-gradient(135deg, #9ca3af 0%, #6b7280 100%) !important;
      }

      @keyframes stepComplete {
          0% { transform: scale(1); }
          50% { transform: scale(1.2); }
          100% { transform: scale(1); }
      }

      @keyframes stepPulse {
          0%, 100% {
              transform: scale(1);
              box-shadow: 0 4px 25px rgba(249, 115, 22, 0.5);
          }
          50% {
              transform: scale(1.08);
              box-shadow: 0 6px 35px rgba(249, 115, 22, 0.7);
          }
      }

      /* Progress Line Animation */
      .progress-line-animated::after {
          animation: progressGrow 1.5s ease-out forwards;
          animation-delay: 0.3s;
      }

      @keyframes progressGrow {
          from { height: 0; }
          to { height: calc(100% - 2rem); }
      }

      /* Step hover glow effect */
      article ol li:hover {
          transform: translateX(4px);
          transition: transform 0.3s ease;
      }

      /* Step click ripple effect */
      .step-ripple::before {
          animation: rippleEffect 0.6s ease-out;
      }

      @keyframes rippleEffect {
          0% {
              transform: scale(1);
              box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
          }
          70% {
              transform: scale(1.15);
              box-shadow: 0 0 0 15px rgba(249, 115, 22, 0);
          }
          100% {
              transform: scale(1);
              box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
          }
      }
  </style>

  <script is:inline define:vars={{ recipe: { title: entry.data.title, slug: entry.slug, image: heroImage } }}>
      // ... (Favorites logic moved to separate block to keep clean, or we can merge. Let's merge for better perf)

      const btn = document.getElementById('fav-btn');
      const icon = document.getElementById('fav-icon');
      const shareBtn = document.getElementById('share-btn');
      const printBtn = document.getElementById('print-btn');
      const progressBar = document.getElementById('scroll-progress');
      const STORAGE_KEY = 'ai_chef_favorites';

      // --- Favorites Logic ---
      if (btn && icon) {
        const isFavorite = () => {
            try {
                const favs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                return favs.some(f => f.slug === recipe.slug);
            } catch (e) { return false; }
        };

        const updateIcon = () => {
            const active = isFavorite();
            icon.textContent = active ? 'favorite' : 'favorite_border';
            icon.classList.toggle('text-red-500', active);
            icon.classList.toggle('fill-current', active);
        };

        btn.onclick = () => {
             // Bounce Animation
             icon.style.transition = "transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)";
             icon.style.transform = "scale(1.4)";
             setTimeout(() => icon.style.transform = "scale(1)", 200);

            try {
                const favs = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
                if (isFavorite()) {
                    const newFavs = favs.filter(f => f.slug !== recipe.slug);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(newFavs));
                } else {
                    favs.push(recipe);
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(favs));
                }
                updateIcon();
            } catch (e) { console.error(e); }
        };

        updateIcon();
      }

      // --- Share Logic ---
      if (shareBtn) {
          shareBtn.onclick = async () => {
              if (navigator.share) {
                  try {
                      await navigator.share({
                          title: recipe.title,
                          text: `Check out this recipe for ${recipe.title} on AI Chef!`,
                          url: window.location.href,
                      });
                  } catch (err) { console.error('Share failed:', err); }
              } else {
                  // Fallback
                  try {
                    await navigator.clipboard.writeText(window.location.href);
                    alert('Link copied to clipboard!');
                  } catch(e) { console.error(e); }
              }
          };
      }

      // --- Print Logic ---
      if (printBtn) {
          printBtn.onclick = () => window.print();
      }

      // --- Scroll Progress Logic ---
      window.addEventListener('scroll', () => {
          if (!progressBar) return;
          const winScroll = document.body.scrollTop || document.documentElement.scrollTop;
          const height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
          const scrolled = (winScroll / height) * 100;
          progressBar.style.width = scrolled + "%";
      });
  </script>

  <!-- Interactive Ingredients & Stepper -->
  <script is:inline define:vars={{ recipeSlug: entry.slug }}>
      document.addEventListener('DOMContentLoaded', () => {
          // --- Interactive Ingredients ---
          // Locate ingredients list - simplified heuristic: first UL in article triggers it,
          // or ideally look for UL after "Ingredientes" header
          // But strict selectors are fragile. Let's try to find ULs that look like ingredient lists (short items)

          const article = document.querySelector('article');
          if (article) {
             const uls = article.querySelectorAll('ul');
             // Typically first UL is ingredients
             if (uls.length > 0) {
                 const ingredientsList = uls[0];
                 const items = ingredientsList.querySelectorAll('li');
                 const ING_KEY = `ing_check_${recipeSlug}`;
                 const checkedState = JSON.parse(localStorage.getItem(ING_KEY) || '{}');

                 items.forEach((li, idx) => {
                     // Style for interactivity
                     li.style.cursor = 'pointer';
                     li.style.transition = 'opacity 0.2s, text-decoration 0.2s';
                     li.title = "Click to mark as done";

                     // Helper to apply state
                     const applyState = (checked) => {
                         if (checked) {
                             li.style.textDecoration = 'line-through';
                             li.style.opacity = '0.5';
                             li.style.color = 'var(--color-gray-400, #9ca3af)';
                         } else {
                             li.style.textDecoration = 'none';
                             li.style.opacity = '1';
                             li.style.color = '';
                         }
                     };

                     // Init state
                     if (checkedState[idx]) applyState(true);

                     // Click handler
                     li.addEventListener('click', () => {
                         const isChecked = li.style.textDecoration === 'line-through';
                         applyState(!isChecked);

                         // Save
                         if (!isChecked) checkedState[idx] = true;
                         else delete checkedState[idx];

                         localStorage.setItem(ING_KEY, JSON.stringify(checkedState));
                     });
                 });
             }
          }

          // --- Stepper Logic (Existing) ---
          // Find all ordered lists within the article (recipe steps)
          const articleOls = document.querySelectorAll('article ol');

          articleOls.forEach(ol => {
              const steps = ol.querySelectorAll('li');
              if (steps.length === 0) return;

              // Add progress line animation class
              ol.classList.add('progress-line-animated');

              // Get saved progress from localStorage
              const PROGRESS_KEY = `recipe_progress_${recipeSlug}`;
              let completedSteps = [];
              try {
                  completedSteps = JSON.parse(localStorage.getItem(PROGRESS_KEY) || '[]');
              } catch (e) { completedSteps = []; }

              // Initialize step states
              const updateStepStates = () => {
                  steps.forEach((step, index) => {
                      // Ensure wait class is removed if present
                      step.classList.remove('step-waiting');
                      step.classList.remove('step-completed', 'step-active', 'step-pending');

                      if (completedSteps.includes(index)) {
                          step.classList.add('step-completed');
                      } else if (completedSteps.length === index) {
                          step.classList.add('step-active');
                      } else {
                          step.classList.add('step-pending');
                      }
                  });
              };

              // Animate steps on scroll using IntersectionObserver
              const observerOptions = {
                  threshold: 0.1, // Lower threshold for better mobile detection
                  rootMargin: '0px 0px -50px 0px'
              };

              const stepObserver = new IntersectionObserver((entries) => {
                  entries.forEach(entry => {
                      if (entry.isIntersecting) {
                          const step = entry.target;
                          const index = Array.from(steps).indexOf(step);

                          // Remove waiting state and animate
                          step.classList.remove('step-waiting');

                          // Staggered animation delay
                          setTimeout(() => {
                              step.classList.add('step-visible');
                          }, index * 100); // Faster stagger

                          stepObserver.unobserve(step);
                      }
                  });
              }, observerOptions);

              steps.forEach(step => {
                   // Add waiting class initially for animation
                   // Only if we want to animate. If JS fails, this won't run, so steps stay visible.
                  step.classList.add('step-waiting');
                  stepObserver.observe(step);
              });

              // Make steps clickable to toggle completion
              steps.forEach((step, index) => {
                  step.style.cursor = 'pointer';

                  step.addEventListener('click', (e) => {
                      // Don't trigger if clicking on a link inside the step
                      if (e.target.tagName === 'A') return;

                      // Add ripple effect
                      step.classList.add('step-ripple');
                      setTimeout(() => step.classList.remove('step-ripple'), 600);

                      // Toggle completion
                      if (completedSteps.includes(index)) {
                          // Remove this and all subsequent completions
                          completedSteps = completedSteps.filter(i => i < index);
                      } else {
                          // Complete all steps up to and including this one
                          for (let i = 0; i <= index; i++) {
                              if (!completedSteps.includes(i)) {
                                  completedSteps.push(i);
                              }
                          }
                          completedSteps.sort((a, b) => a - b);
                      }

                      // Save to localStorage
                      try {
                          localStorage.setItem(PROGRESS_KEY, JSON.stringify(completedSteps));
                      } catch (e) { console.error('Could not save progress:', e); }

                      updateStepStates();
                  });
              });

              // Initial state update
              updateStepStates();

              // Add reset button if there's progress
              if (completedSteps.length > 0) {
                  const resetBtn = document.createElement('button');
                  resetBtn.innerHTML = '<span class="material-symbols-outlined text-sm">restart_alt</span> Reiniciar pasos';
                  resetBtn.className = 'mt-4 flex items-center gap-2 text-xs text-gray-400 hover:text-primary transition-colors';
                  resetBtn.onclick = () => {
                      completedSteps = [];
                      try {
                          localStorage.removeItem(PROGRESS_KEY);
                      } catch (e) {}
                      updateStepStates();
                      resetBtn.remove();
                  };
                  ol.parentNode.insertBefore(resetBtn, ol.nextSibling);
              }
          });
      });
  </script>
</Layout>
