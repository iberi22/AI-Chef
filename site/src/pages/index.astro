---
import Layout from '../layouts/Layout.astro';
import RecipeCard from '../components/RecipeCard.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

const allRecipes = await getCollection('dishes');

// Helper to find image in category
// Helper to find image in category
function findImage(recipe: any) {
  const body = recipe.body;

  // Match markdown image ![alt](url) or HTML <img src="url">
  let imagePath = null;
  // Improved regex to handle one level of parentheses in filenames e.g. image(1).jpg
  const mdMatch = body.match(/!\[.*?\]\(((?:[^()]+|\([^()]*\))+)\)/);
  if (mdMatch && !mdMatch[1].endsWith('.svg')) {
     imagePath = mdMatch[1];
  } else {
     const htmlMatch = body.match(/<img.*?src=["'](.*?)["']/);
     if (htmlMatch && !htmlMatch[1].endsWith('.svg')) {
        imagePath = htmlMatch[1];
     }
  }

  if (!imagePath) return undefined;

  // 1. Check for external URLs (http/https)
  if (imagePath.match(/^https?:\/\//)) {
      return imagePath;
  }

  // 2. Resolve relative paths
  if (imagePath.startsWith('./') || !imagePath.startsWith('/')) {
     // Remove ./ if present
     const cleanPath = imagePath.replace(/^\.\//, '');

     // Construct path based on recipe ID location
     // recipe.id = "drink/some-drink.md" -> dir = "drink"
     const lastSlashIndex = recipe.id.lastIndexOf('/');
     const dir = lastSlashIndex !== -1 ? recipe.id.substring(0, lastSlashIndex) : '';

     // Final path: /AI-Chef/dishes/{dir}/{image_filename}
     // Note: This relies on the fact we copied 'dishes' to 'public/dishes'
     return `${import.meta.env.BASE_URL}/dishes/${dir}/${cleanPath}`.replace(/\/+/g, '/'); // ensure no double slashes
  }

  return imagePath;
}

function getTitle(recipe: any) {
    if (recipe.data.title) return recipe.data.title;
    // Try to extract from first H1 in body
    const match = recipe.body.match(/^#\s+(.+)$/m);
    if (match) return match[1];
    // Fallback to slug last segment (filename)
    const filename = recipe.slug.split('/').pop();
    return filename ? decodeURIComponent(filename) : 'Untitled';
}

const recipesWithImages = allRecipes.map(recipe => ({
  ...recipe,
  image: findImage(recipe),
  computedTitle: getTitle(recipe)
})).filter(recipe => {
    // FILTER: Only show Colombian recipes for now
    const isColombianRecipe = recipe.slug.startsWith('colombian');
    const hasRegion = !!recipe.data.region;
    return isColombianRecipe && hasRegion;
}).sort((a, b) => {
    // SORT: Recipes with images first
    const aHasImage = !!a.image;
    const bHasImage = !!b.image;
    if (aHasImage && !bHasImage) return -1;
    if (!aHasImage && bHasImage) return 1;
    return 0;
});

// Only show Colombian category for now (China, Peru disabled)
const categories = ['colombian'];
const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="AI-Chef Home (Menu)">
  <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
    <!-- Navigation -->
    <header class="sticky top-0 z-50 w-full glass-panel border-b border-[#e6e6db] dark:border-[#333]">
      <div class="mx-auto flex h-20 max-w-[1440px] items-center justify-between px-6 lg:px-10">
        <!-- Logo -->
        <div class="flex items-center gap-4">
          <div class="flex size-10 items-center justify-center rounded-xl overflow-hidden shadow-neon">
            <img src={`${baseUrl}/images/logo.png`} alt="Logo" class="h-full w-full object-cover" />
          </div>
          <h2 class="hidden text-xl font-bold tracking-tight md:block bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">AI-Chef</h2>
        </div>
        <!-- Search -->
        <div class="mx-4 hidden max-w-md flex-1 md:block">
          <label class="relative flex h-12 w-full items-center overflow-hidden rounded-full bg-surface-light/50 dark:bg-surface-dark/50 shadow-sm ring-1 ring-black/5 dark:ring-white/10 focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2 dark:focus-within:ring-offset-black">
            <div class="flex h-full items-center justify-center pl-4 text-gray-400 dark:text-gray-500">
              <span class="material-symbols-outlined">search</span>
            </div>
            <input id="search-input" class="h-full w-full border-none bg-transparent px-3 text-sm font-medium text-text-light dark:text-text-dark placeholder:text-gray-400 focus:outline-none focus:ring-0" placeholder="Search for logic-based recipes..."/>
          </label>
        </div>
        <!-- Actions -->
        <div class="flex items-center gap-3 md:gap-6">
          <nav class="hidden gap-6 md:flex">
            <a class="text-sm font-medium hover:text-primary transition-colors" href={baseUrl}>Home</a>
            <a class="text-sm font-medium text-gray-500 hover:text-primary dark:text-gray-400 transition-colors" href={`${baseUrl}/favorites`} id="nav-favorites">My Recipes</a>
            <a class="text-sm font-medium text-gray-500 hover:text-primary dark:text-gray-400 transition-colors" href="#">Community</a>
          </nav>
          <div class="flex items-center gap-2 border-l border-gray-200 pl-2 dark:border-gray-800 md:pl-6">
            <!-- Language Selector -->
            <div id="google_translate_element" class="hidden md:block"></div>
            <ThemeToggle />
            <button class="flex size-10 items-center justify-center rounded-full hover:bg-black/5 dark:hover:bg-white/5 transition-colors text-gray-600 dark:text-gray-300">
              <span class="material-symbols-outlined">notifications</span>
            </button>
            <button class="group relative flex size-10 items-center justify-center overflow-hidden rounded-full border border-gray-200 dark:border-gray-700">
              <div class="bg-center bg-no-repeat bg-cover w-full h-full" style={`background-image: url("${baseUrl}/images/cover_collage.png");`}></div>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1">
      <!-- Hero Section -->
      <div class="relative w-full px-6 py-12 lg:px-10 lg:py-16">
        <div class="mx-auto max-w-[1440px]">
          <div class="relative overflow-hidden rounded-2xl bg-surface-dark dark:bg-surface-light/5 px-8 py-16 text-center md:px-16 md:py-24 shadow-2xl ring-1 ring-white/10">
            <!-- Decorative bg -->
            <div class="absolute inset-0 z-0 opacity-10" style="background-image: linear-gradient(#FF6347 1px, transparent 1px), linear-gradient(to right, #FF6347 1px, transparent 1px); background-size: 40px 40px;"></div>
            <div class="absolute inset-0 z-0 bg-cover bg-center opacity-20" style={`background-image: url("${baseUrl}/images/cover_collage.png");`}></div>
            <div class="absolute inset-0 z-0 bg-gradient-to-b from-transparent via-background-dark/80 to-background-dark"></div>
            <div class="relative z-10 mx-auto flex max-w-3xl flex-col items-center gap-6">
              <div class="inline-flex items-center rounded-full border border-secondary/30 bg-secondary/10 px-3 py-1 backdrop-blur-sm">
                <span class="text-xs font-bold uppercase tracking-wider text-primary font-mono">v2.0 Beta Live</span>
              </div>
              <h1 class="font-display text-4xl font-black tracking-tight text-white md:text-6xl lg:text-7xl">
                Cook Smarter, <br/><span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Not Harder</span>
              </h1>
              <p class="max-w-xl text-lg text-gray-400 md:text-xl font-light">
                AI-powered recipes generated from your GitHub logic. Fork existing flavors or commit new culinary experiments.
              </p>
              <div class="mt-4 flex flex-col gap-4 sm:flex-row">
                <button class="group relative inline-flex h-12 items-center justify-center overflow-hidden rounded-full bg-primary px-8 font-bold text-black shadow-neon transition-all hover:scale-105 hover:shadow-neon-hover">
                  <span class="mr-2 material-symbols-outlined text-[20px]">bolt</span>
                  <span>Generate Recipe</span>
                </button>
                <button class="inline-flex h-12 items-center justify-center rounded-full border border-gray-600 bg-transparent px-8 font-medium text-white transition-colors hover:bg-white/10 hover:border-white">
                  <span>Browse Documentation</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="sticky top-20 z-30 w-full border-b border-gray-200 bg-background-light/95 backdrop-blur dark:border-gray-800 dark:bg-background-dark/95">
        <div class="mx-auto flex max-w-[1440px] items-center gap-3 overflow-x-auto px-6 py-4 lg:px-10 scrollbar-hide" id="category-filters">
          <button data-category="all" class="category-btn active flex h-10 shrink-0 items-center gap-2 rounded-full border border-transparent bg-black px-5 text-sm font-bold text-white transition-transform hover:scale-105 dark:bg-white dark:text-black">
            <span class="material-symbols-outlined text-[18px]">tune</span>
            <span>All Recipes</span>
          </button>
          {categories.map(category => (
            <button data-category={category} class="category-btn flex h-10 shrink-0 items-center gap-2 rounded-full border border-gray-200 bg-white px-5 text-sm font-medium text-text-light transition-all hover:border-primary hover:text-primary dark:border-gray-700 dark:bg-surface-dark dark:text-text-dark dark:hover:border-primary capitalize">
              <span class="material-symbols-outlined text-[18px]">category</span>
              <span>{category}</span>
            </button>
          ))}
          <button class="ml-auto flex size-10 shrink-0 items-center justify-center rounded-full border border-gray-200 bg-white hover:bg-gray-50 dark:border-gray-700 dark:bg-surface-dark dark:hover:bg-white/5">
            <span class="material-symbols-outlined text-[20px]">filter_list</span>
          </button>
        </div>
      </div>

      <!-- Recipe Grid -->
      <div class="mx-auto max-w-[1440px] px-6 py-8 lg:px-10">
        <div id="recipe-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {recipesWithImages.map((recipe, index) => (
            <div
              class={`recipe-item ${index >= 20 ? 'hidden' : ''}`}
              data-category={recipe.slug.split('/')[0]}
              data-title={recipe.computedTitle.toLowerCase()}
              data-index={index}
            >
              <RecipeCard
                title={recipe.computedTitle}
                slug={recipe.slug}
                image={recipe.image}
                category={recipe.slug.split('/')[0]}
                region={recipe.data.region}
                originalName={recipe.data.original_name}
                difficulty={recipe.data.difficulty}
                time={recipe.data.cook_time}
                calories={recipe.data.nutrition?.calories}
                rating={recipe.data.rating}
              />
            </div>
          ))}
        </div>

        <!-- Loading indicator for infinite scroll -->
        <div id="loading-more" class="hidden py-8 text-center">
          <div class="inline-flex items-center gap-2 text-gray-500 dark:text-gray-400">
            <span class="material-symbols-outlined animate-spin">progress_activity</span>
            <span>Cargando más recetas...</span>
          </div>
        </div>

        <!-- End of recipes indicator -->
        <div id="end-of-recipes" class="hidden py-8 text-center">
          <div class="inline-flex items-center gap-2 text-gray-400 dark:text-gray-500">
            <span class="material-symbols-outlined">check_circle</span>
            <span>¡Has visto todas las recetas!</span>
          </div>
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden py-20 text-center">
            <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 mb-4">
                <span class="material-symbols-outlined text-3xl text-gray-400">search_off</span>
            </div>
            <h3 class="text-lg font-bold text-text-light dark:text-text-dark">No recipes found</h3>
            <p class="text-gray-500 dark:text-gray-400">Try adjusting your search or filters.</p>
        </div>
      </div>
    </main>
    <Footer />
  </div>
</Layout>

<script>
  // Client-side filtering and search logic
  document.addEventListener('astro:page-load', async () => {
    const searchInput = document.getElementById('search-input');
    const categoryBtns = document.querySelectorAll('.category-btn');
    const recipeGrid = document.getElementById('recipe-grid');
    const noResults = document.getElementById('no-results');
    const navFavorites = document.getElementById('nav-favorites');
    const loadingIndicator = document.getElementById('loading-more');

    let allRecipes = []; // Will hold the fetched search index
    let currentCategory = 'all';
    let currentSearch = '';
    let showFavoritesOnly = false;
    const baseUrl = import.meta.env.BASE_URL === '/' ? '' : import.meta.env.BASE_URL;

    // Load favorites from localStorage
    const getFavorites = () => JSON.parse(localStorage.getItem('ai_chef_favorites') || '[]');
    const setFavorites = (favs) => localStorage.setItem('ai_chef_favorites', JSON.stringify(favs));

    // Fetch Search Index
    try {
        const response = await fetch(`${baseUrl}/search-index.json`);
        allRecipes = await response.json();
    } catch (error) {
        console.error("Failed to load search index:", error);
    }

    // Initialize favorite buttons delegated event
    // We delegate because we re-render grid items dynamically
    recipeGrid?.addEventListener('click', (e) => {
        const btn = e.target.closest('.fav-btn');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const slug = btn.dataset.slug;
        if (!slug) return;

        const currentFavs = getFavorites();
        if (currentFavs.some(f => f.slug === slug)) { // Check by slug
             const newFavs = currentFavs.filter(f => f.slug !== slug);
             setFavorites(newFavs);
             btn.classList.remove('active');
        } else {
             // Find recipe data to save minimal info
             const recipeData = allRecipes.find(r => r.slug === slug);
             if (recipeData) {
                 // Save minimal data needed for rendering favorites page
                 currentFavs.push({
                     slug: recipeData.slug,
                     title: recipeData.title,
                     image: recipeData.image
                 });
                 setFavorites(currentFavs);
                 btn.classList.add('active');
             }
        }

        // Update styling if in favorites mode
        if (showFavoritesOnly) {
            renderRecipes();
        }
    });

    // Initial Active States for SSR buttons
    function updateFavoriteButtons() {
        const favorites = getFavorites();
        document.querySelectorAll('.fav-btn').forEach(btn => {
            const slug = btn.dataset.slug;
            if (favorites.some(f => f.slug === slug)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });
    }

    function generateCardHTML(recipe) {
        // Fallback for SSR items that might differ slightly in data structure
        // But here we rely on search-index.json structure
        const isFav = getFavorites().some(f => f.slug === recipe.slug);
        const imageSrc = recipe.image || '';

        // Replicating RecipeCard structure roughly
        return `
            <div
              class="recipe-item group relative flex flex-col overflow-hidden rounded-2xl bg-surface-light dark:bg-surface-dark shadow-sm ring-1 ring-black/5 dark:ring-white/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-neon hover:ring-primary/50"
              data-category="${recipe.category || 'other'}"
              data-title="${recipe.title.toLowerCase()}"
            >
              <a href="${baseUrl}/dishes/${recipe.slug}" class="absolute inset-0 z-0" aria-label="View recipe: ${recipe.title}"></a>

              <div class="aspect-[4/3] w-full overflow-hidden bg-gray-100 dark:bg-gray-800 relative pointer-events-none">
                ${imageSrc ?
                   `<img src="${imageSrc}" alt="${recipe.title}" class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />`
                   : `<div class="flex h-full w-full items-center justify-center text-gray-300 dark:text-gray-600"><span class="material-symbols-outlined text-6xl">restaurant_menu</span></div>`
                }

                <div class="absolute top-3 right-3 z-20 pointer-events-auto">
                  <button class="fav-btn flex size-8 items-center justify-center rounded-full bg-white/90 backdrop-blur-sm text-gray-400 shadow-sm transition-all hover:scale-110 hover:text-red-500 dark:bg-black/60 ${isFav ? 'active' : ''}" data-slug="${recipe.slug}" aria-label="Add to favorites">
                    <span class="material-symbols-outlined text-[20px] font-variation-settings-fill ${isFav ? 'text-red-500 fill-1' : ''}">favorite</span>
                  </button>
                </div>
                 <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100"></div>
                 ${recipe.region ? `<div class="absolute bottom-3 left-3"><span class="inline-flex items-center rounded-md bg-black/60 px-2 py-1 text-xs font-medium text-white backdrop-blur-md">${recipe.region}</span></div>` : ''}
              </div>

              <div class="flex flex-1 flex-col p-5 pointer-events-none">
                 <div class="mb-2 flex items-center justify-between">
                    <span class="text-xs font-bold uppercase tracking-wider text-primary">${recipe.category || 'Recipe'}</span>
                    ${recipe.rating ? `<div class="flex items-center gap-1 text-xs font-bold text-yellow-500"><span class="material-symbols-outlined text-[14px] fill-1">star</span><span>${recipe.rating}</span></div>` : ''}
                 </div>
                 <h3 class="mb-2 font-display text-xl font-bold leading-tight text-text-light dark:text-text-dark group-hover:text-primary transition-colors line-clamp-2">
                    ${recipe.title}
                 </h3>
                 <div class="mt-auto flex items-center gap-4 text-xs font-medium text-gray-500 dark:text-gray-400">
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-[16px]">schedule</span>
                        <span>${recipe.time || 'N/A'}</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span class="material-symbols-outlined text-[16px]">local_fire_department</span>
                        <span>${recipe.calories || 'N/A'} cal</span>
                    </div>
                 </div>
              </div>
            </div>
        `;
    }

    function renderRecipes() {
        if (!allRecipes.length) return; // Wait until index is loaded

        const favorites = getFavorites();

        let filtered = allRecipes.filter(r => {
             // Category Filter
             const matchCat = currentCategory === 'all' || r.category === currentCategory;

             // Search Filter (Title + Ingredients)
             const searchLower = currentSearch.toLowerCase();
             const matchSearch = !currentSearch ||
                                 r.title.toLowerCase().includes(searchLower) ||
                                 (r.ingredients && r.ingredients.includes(searchLower));

             // Favorites Filter
             const matchFav = !showFavoritesOnly || favorites.some(f => f.slug === r.slug);

             return matchCat && matchSearch && matchFav;
        });

        // Limit results if too many? For now render all but maybe implement pagination if needed in future
        // We'll just render them all for simplicity as requested "el buscador funcione"

        if (filtered.length === 0) {
             noResults.classList.remove('hidden');
             recipeGrid.innerHTML = '';
        } else {
             noResults.classList.add('hidden');
             // Rebuild Grid
             recipeGrid.innerHTML = filtered.map(generateCardHTML).join('');
        }
    }

    // Search Event
    searchInput?.addEventListener('input', (e) => {
      currentSearch = e.target.value;
      if (allRecipes.length) {
          renderRecipes();
      }
    });

    // Category Events
    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        showFavoritesOnly = false;
        navFavorites?.classList.remove('text-primary');

        categoryBtns.forEach(b => {
            b.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
            b.classList.add('bg-white', 'text-text-light', 'dark:bg-surface-dark', 'dark:text-text-dark');
        });
        btn.classList.remove('bg-white', 'text-text-light', 'dark:bg-surface-dark', 'dark:text-text-dark');
        btn.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');

        currentCategory = btn.dataset.category || 'all';
        renderRecipes();
      });
    });

    // Favorites Filter Event
    navFavorites?.addEventListener('click', (e) => {
        e.preventDefault();
        showFavoritesOnly = !showFavoritesOnly;

        if (showFavoritesOnly) {
            navFavorites.classList.add('text-primary');
        } else {
            navFavorites.classList.remove('text-primary');
        }
        renderRecipes();
    });

    // Initial buttons update
    updateFavoriteButtons();

    // Auto-load index if not loaded yet
    setTimeout(() => {
        if (allRecipes.length === 0) {
             // Retry or just wait for fetch
        } else {
            // Optional: Re-render if you want to ensure parity between SSR and Client content
            // but SSR content is fine for initial view.
            // Actually, we should probably establish our "truth" from the index to enable full search immediately
            // But lets wait for user interaction or index load.
        }
    }, 500);

  });
</script>

