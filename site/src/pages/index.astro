---
import Layout from '../layouts/Layout.astro';
import RecipeCard from '../components/RecipeCard.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import Footer from '../components/Footer.astro';
import { getCollection } from 'astro:content';

const allRecipes = await getCollection('dishes');

// Helper to find image in category
// Helper to find image in category
function findImage(recipe: any) {
  const body = recipe.body;

  // Match markdown image ![alt](url) or HTML <img src="url">
  let imagePath = null;
  // Improved regex to handle one level of parentheses in filenames e.g. image(1).jpg
  const mdMatch = body.match(/!\[.*?\]\(((?:[^()]+|\([^()]*\))+)\)/);
  if (mdMatch && !mdMatch[1].endsWith('.svg')) {
     imagePath = mdMatch[1];
  } else {
     const htmlMatch = body.match(/<img.*?src=["'](.*?)["']/);
     if (htmlMatch && !htmlMatch[1].endsWith('.svg')) {
        imagePath = htmlMatch[1];
     }
  }

  if (!imagePath) return undefined;

  // 1. Check for external URLs (http/https)
  if (imagePath.match(/^https?:\/\//)) {
      return imagePath;
  }

  // 2. Resolve relative paths
  if (imagePath.startsWith('./') || !imagePath.startsWith('/')) {
     // Remove ./ if present
     const cleanPath = imagePath.replace(/^\.\//, '');

     // Construct path based on recipe ID location
     // recipe.id = "drink/some-drink.md" -> dir = "drink"
     const lastSlashIndex = recipe.id.lastIndexOf('/');
     const dir = lastSlashIndex !== -1 ? recipe.id.substring(0, lastSlashIndex) : '';

     // Final path: /AI-Chef/dishes/{dir}/{image_filename}
     // Note: This relies on the fact we copied 'dishes' to 'public/dishes'
     return `${import.meta.env.BASE_URL}/dishes/${dir}/${cleanPath}`.replace(/\/+/g, '/'); // ensure no double slashes
  }

  return imagePath;
}

function getTitle(recipe: any) {
    if (recipe.data.title) return recipe.data.title;
    // Try to extract from first H1 in body
    const match = recipe.body.match(/^#\s+(.+)$/m);
    if (match) return match[1];
    // Fallback to slug last segment (filename)
    const filename = recipe.slug.split('/').pop();
    return filename ? decodeURIComponent(filename) : 'Untitled';
}

const recipesWithImages = allRecipes.map(recipe => ({
  ...recipe,
  image: findImage(recipe),
  computedTitle: getTitle(recipe)
})).filter(recipe => {
    // FILTER: Only show "Complete" recipes (Standard metadata present)
    // The user wants to hide Chinese recipes that lack this standard for now.
    const hasRegion = !!recipe.data.region;
    const hasNutrition = !!recipe.data.nutrition;
    // We can also check for specific flags if we want to force specific ones
    // return hasRegion && hasNutrition;
    return hasRegion; // Start with Region check as a strong signal of "New Standard"
});

const categories = [...new Set(allRecipes.map(r => r.slug.split('/')[0]))].sort();
const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="AI-Chef Home (Menu)">
  <div class="relative flex min-h-screen w-full flex-col overflow-x-hidden">
    <!-- Navigation -->
    <header class="sticky top-0 z-50 w-full glass-panel border-b border-[#e6e6db] dark:border-[#333]">
      <div class="mx-auto flex h-20 max-w-[1440px] items-center justify-between px-6 lg:px-10">
        <!-- Logo -->
        <div class="flex items-center gap-4">
          <div class="flex size-10 items-center justify-center rounded-xl overflow-hidden shadow-neon">
            <img src={`${baseUrl}/images/logo.png`} alt="Logo" class="h-full w-full object-cover" />
          </div>
          <h2 class="hidden text-xl font-bold tracking-tight md:block bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">AI-Chef</h2>
        </div>
        <!-- Search -->
        <div class="mx-4 hidden max-w-md flex-1 md:block">
          <label class="relative flex h-12 w-full items-center overflow-hidden rounded-full bg-surface-light/50 dark:bg-surface-dark/50 shadow-sm ring-1 ring-black/5 dark:ring-white/10 focus-within:ring-2 focus-within:ring-primary focus-within:ring-offset-2 dark:focus-within:ring-offset-black">
            <div class="flex h-full items-center justify-center pl-4 text-gray-400 dark:text-gray-500">
              <span class="material-symbols-outlined">search</span>
            </div>
            <input id="search-input" class="h-full w-full border-none bg-transparent px-3 text-sm font-medium text-text-light dark:text-text-dark placeholder:text-gray-400 focus:outline-none focus:ring-0" placeholder="Search for logic-based recipes..."/>
          </label>
        </div>
        <!-- Actions -->
        <div class="flex items-center gap-3 md:gap-6">
          <nav class="hidden gap-6 md:flex">
            <a class="text-sm font-medium hover:text-primary transition-colors" href={baseUrl}>Home</a>
            <a class="text-sm font-medium text-gray-500 hover:text-primary dark:text-gray-400 transition-colors" href={`${baseUrl}/favorites`} id="nav-favorites">My Recipes</a>
            <a class="text-sm font-medium text-gray-500 hover:text-primary dark:text-gray-400 transition-colors" href="#">Community</a>
          </nav>
          <div class="flex items-center gap-2 border-l border-gray-200 pl-2 dark:border-gray-800 md:pl-6">
            <ThemeToggle />
            <button class="flex size-10 items-center justify-center rounded-full hover:bg-black/5 dark:hover:bg-white/5 transition-colors text-gray-600 dark:text-gray-300">
              <span class="material-symbols-outlined">notifications</span>
            </button>
            <button class="group relative flex size-10 items-center justify-center overflow-hidden rounded-full border border-gray-200 dark:border-gray-700">
              <div class="bg-center bg-no-repeat bg-cover w-full h-full" style={`background-image: url("${baseUrl}/images/cover_collage.png");`}></div>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1">
      <!-- Hero Section -->
      <div class="relative w-full px-6 py-12 lg:px-10 lg:py-16">
        <div class="mx-auto max-w-[1440px]">
          <div class="relative overflow-hidden rounded-2xl bg-surface-dark dark:bg-surface-light/5 px-8 py-16 text-center md:px-16 md:py-24 shadow-2xl ring-1 ring-white/10">
            <!-- Decorative bg -->
            <div class="absolute inset-0 z-0 opacity-10" style="background-image: linear-gradient(#FF6347 1px, transparent 1px), linear-gradient(to right, #FF6347 1px, transparent 1px); background-size: 40px 40px;"></div>
            <div class="absolute inset-0 z-0 bg-cover bg-center opacity-20" style={`background-image: url("${baseUrl}/images/cover_collage.png");`}></div>
            <div class="absolute inset-0 z-0 bg-gradient-to-b from-transparent via-background-dark/80 to-background-dark"></div>
            <div class="relative z-10 mx-auto flex max-w-3xl flex-col items-center gap-6">
              <div class="inline-flex items-center rounded-full border border-secondary/30 bg-secondary/10 px-3 py-1 backdrop-blur-sm">
                <span class="text-xs font-bold uppercase tracking-wider text-primary font-mono">v2.0 Beta Live</span>
              </div>
              <h1 class="font-display text-4xl font-black tracking-tight text-white md:text-6xl lg:text-7xl">
                Cook Smarter, <br/><span class="text-transparent bg-clip-text bg-gradient-to-r from-primary to-secondary">Not Harder</span>
              </h1>
              <p class="max-w-xl text-lg text-gray-400 md:text-xl font-light">
                AI-powered recipes generated from your GitHub logic. Fork existing flavors or commit new culinary experiments.
              </p>
              <div class="mt-4 flex flex-col gap-4 sm:flex-row">
                <button class="group relative inline-flex h-12 items-center justify-center overflow-hidden rounded-full bg-primary px-8 font-bold text-black shadow-neon transition-all hover:scale-105 hover:shadow-neon-hover">
                  <span class="mr-2 material-symbols-outlined text-[20px]">bolt</span>
                  <span>Generate Recipe</span>
                </button>
                <button class="inline-flex h-12 items-center justify-center rounded-full border border-gray-600 bg-transparent px-8 font-medium text-white transition-colors hover:bg-white/10 hover:border-white">
                  <span>Browse Documentation</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="sticky top-20 z-30 w-full border-b border-gray-200 bg-background-light/95 backdrop-blur dark:border-gray-800 dark:bg-background-dark/95">
        <div class="mx-auto flex max-w-[1440px] items-center gap-3 overflow-x-auto px-6 py-4 lg:px-10 scrollbar-hide" id="category-filters">
          <button data-category="all" class="category-btn active flex h-10 shrink-0 items-center gap-2 rounded-full border border-transparent bg-black px-5 text-sm font-bold text-white transition-transform hover:scale-105 dark:bg-white dark:text-black">
            <span class="material-symbols-outlined text-[18px]">tune</span>
            <span>All Recipes</span>
          </button>
          {categories.map(category => (
            <button data-category={category} class="category-btn flex h-10 shrink-0 items-center gap-2 rounded-full border border-gray-200 bg-white px-5 text-sm font-medium text-text-light transition-all hover:border-primary hover:text-primary dark:border-gray-700 dark:bg-surface-dark dark:text-text-dark dark:hover:border-primary capitalize">
              <span class="material-symbols-outlined text-[18px]">category</span>
              <span>{category}</span>
            </button>
          ))}
          <button class="ml-auto flex size-10 shrink-0 items-center justify-center rounded-full border border-gray-200 bg-white hover:bg-gray-50 dark:border-gray-700 dark:bg-surface-dark dark:hover:bg-white/5">
            <span class="material-symbols-outlined text-[20px]">filter_list</span>
          </button>
        </div>
      </div>

      <!-- Recipe Grid -->
      <div class="mx-auto max-w-[1440px] px-6 py-8 lg:px-10">
        <div id="recipe-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
          {recipesWithImages.map(recipe => (
            <div class="recipe-item" data-category={recipe.slug.split('/')[0]} data-title={recipe.computedTitle.toLowerCase()}>
              <RecipeCard
                title={recipe.computedTitle}
                slug={recipe.slug}
                image={recipe.image}
                category={recipe.slug.split('/')[0]}
                region={recipe.data.region}
                originalName={recipe.data.original_name}
                difficulty={recipe.data.difficulty}
                time={recipe.data.cook_time}
                calories={recipe.data.nutrition?.calories}
                rating={recipe.data.rating}
              />
            </div>
          ))}
        </div>

        <!-- No Results Message -->
        <div id="no-results" class="hidden py-20 text-center">
            <div class="inline-flex h-16 w-16 items-center justify-center rounded-full bg-gray-100 dark:bg-gray-800 mb-4">
                <span class="material-symbols-outlined text-3xl text-gray-400">search_off</span>
            </div>
            <h3 class="text-lg font-bold text-text-light dark:text-text-dark">No recipes found</h3>
            <p class="text-gray-500 dark:text-gray-400">Try adjusting your search or filters.</p>
        </div>
      </div>
    </main>
    <Footer />
  </div>
</Layout>

<script>
  // Client-side filtering logic
  document.addEventListener('astro:page-load', () => {
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    const categoryBtns = document.querySelectorAll('.category-btn');
    const recipeItems = document.querySelectorAll('.recipe-item');
    const noResults = document.getElementById('no-results');
    const navFavorites = document.getElementById('nav-favorites');

    let currentCategory = 'all';
    let currentSearch = '';
    let showFavoritesOnly = false;

    // Load favorites from localStorage
    const getFavorites = () => JSON.parse(localStorage.getItem('ai-chef-favorites') || '[]');
    const setFavorites = (favs: string[]) => localStorage.setItem('ai-chef-favorites', JSON.stringify(favs));

    // Initialize favorite buttons
    function initFavoriteButtons() {
        const favorites = getFavorites();
        document.querySelectorAll('.fav-btn').forEach(btn => {
            const slug = (btn as HTMLElement).dataset.slug;
            if (slug && favorites.includes(slug)) {
                btn.classList.add('active');
            }

            // Remove old listeners to avoid duplicates if re-running (though page-load runs once per nav)
            const newBtn = btn.cloneNode(true);
            btn.parentNode?.replaceChild(newBtn, btn);

            newBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                const target = e.currentTarget as HTMLElement;
                const s = target.dataset.slug;
                if (!s) return;

                const currentFavs = getFavorites();
                if (currentFavs.includes(s)) {
                    const newFavs = currentFavs.filter(f => f !== s);
                    setFavorites(newFavs);
                    target.classList.remove('active');
                } else {
                    currentFavs.push(s);
                    setFavorites(currentFavs);
                    target.classList.add('active');
                }

                // If we are in favorites view, re-filter to hide removed item
                if (showFavoritesOnly) {
                    filterRecipes();
                }
            });
        });
    }

    function filterRecipes() {
      let visibleCount = 0;
      const favorites = getFavorites();

      recipeItems.forEach(item => {
        const itemCategory = (item as HTMLElement).dataset.category;
        const itemTitle = (item as HTMLElement).dataset.title;
        // We need to get the slug from the RecipeCard link inside the item
        // Or better, get it from the fav-btn inside
        const favBtn = item.querySelector('.fav-btn') as HTMLElement;
        const slug = favBtn?.dataset.slug;

        const matchesCategory = currentCategory === 'all' || itemCategory === currentCategory;
        const matchesSearch = itemTitle?.includes(currentSearch);
        const matchesFavorite = !showFavoritesOnly || (slug && favorites.includes(slug));

        if (matchesCategory && matchesSearch && matchesFavorite) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      if (noResults) {
        noResults.classList.toggle('hidden', visibleCount === 0);
      }
    }

    // Initialize
    initFavoriteButtons();

    // Random shuffle Logic
    function shuffleArray(array: any[]) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    // Shuffle grid items on load (only if not sorting explicitly)
    function randomShuffleGrid() {
        const grid = document.getElementById('recipe-grid');
        if (!grid) return;

        const items = Array.from(grid.children);
        const shuffled = shuffleArray(items);

        // Use DocumentFragment for performance
        const fragment = document.createDocumentFragment();
        shuffled.forEach(item => fragment.appendChild(item));
        grid.appendChild(fragment);
    }

    // Execute shuffle
    randomShuffleGrid();

    // Load persisted filters if any (Optional - for now just shuffle)
    // const savedCategory = localStorage.getItem('ai-chef-category');
    // if(savedCategory) { ... }

    // Search Event
    searchInput?.addEventListener('input', (e) => {
      currentSearch = (e.target as HTMLInputElement).value.toLowerCase();
      filterRecipes();
    });

    // Category Events
    categoryBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        // Reset favorites mode if active
        showFavoritesOnly = false;
        navFavorites?.classList.remove('text-primary');

        // Update active state
        categoryBtns.forEach(b => {
            b.classList.remove('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');
            b.classList.add('bg-white', 'text-text-light', 'dark:bg-surface-dark', 'dark:text-text-dark');
        });
        btn.classList.remove('bg-white', 'text-text-light', 'dark:bg-surface-dark', 'dark:text-text-dark');
        btn.classList.add('bg-black', 'text-white', 'dark:bg-white', 'dark:text-black');

        const newCategory = (btn as HTMLElement).dataset.category || 'all';
        currentCategory = newCategory;

        // Persist category preference? Maybe annoying if random is default.
        // localStorage.setItem('ai-chef-category', newCategory);

        filterRecipes();
      });
    });

    // Favorites Filter Event
    navFavorites?.addEventListener('click', (e) => {
        e.preventDefault();
        showFavoritesOnly = !showFavoritesOnly;

        if (showFavoritesOnly) {
            navFavorites.classList.add('text-primary');
            // Reset category visual state to "all" or none, but logic handles it
        } else {
            navFavorites.classList.remove('text-primary');
        }
        filterRecipes();
    });
  });
</script>
