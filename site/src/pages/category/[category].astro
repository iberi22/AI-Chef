---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allRecipes = await getCollection('dishes');

  // Get unique categories
  const categories = [...new Set(allRecipes.map(recipe => recipe.slug.split('/')[0]))];

  return categories.map(category => {
    const categoryRecipes = allRecipes.filter(recipe => recipe.slug.startsWith(category + '/'));
    return {
      params: { category },
      props: { category, recipes: categoryRecipes },
    };
  });
}

const { category, recipes } = Astro.props;
const baseUrl = import.meta.env.BASE_URL;

function getRecipeImage(recipe: any) {
  const body = recipe.body;
  const mdMatch = body.match(/!\[.*?\]\((.*?)\)/);
  if (mdMatch) return mdMatch[1];
  const htmlMatch = body.match(/<img.*?src=["'](.*?)["']/);
  if (htmlMatch) return htmlMatch[1];
  return null;
}
---

<Layout title={`Recetas de ${category}`}>
  <div class="relative min-h-screen w-full flex flex-col">
    <!-- Header -->
    <header class="sticky top-0 z-50 w-full glass-panel border-b border-[#e6e6db] dark:border-[#333]">
      <div class="mx-auto flex h-20 max-w-[1440px] items-center justify-between px-6 lg:px-10">
        <div class="flex items-center gap-4">
          <a href={import.meta.env.BASE_URL} class="flex size-10 items-center justify-center rounded-xl bg-primary text-black shadow-neon hover:scale-105 transition-transform">
            <span class="material-symbols-outlined">arrow_back</span>
          </a>
          <h2 class="text-xl font-bold tracking-tight hidden md:block capitalize">{category.replace(/_/g, ' ')}</h2>
        </div>
      </div>
    </header>

    <main class="flex-1 container mx-auto px-4 py-8 max-w-[1440px]">
      <div class="mb-8">
        <h1 class="font-display text-4xl font-black tracking-tight text-text-light dark:text-text-dark capitalize">
          {category.replace(/_/g, ' ')}
        </h1>
        <p class="text-gray-600 dark:text-gray-400 mt-2">{recipes.length} recipes found</p>
      </div>

      <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        {recipes.map((recipe) => {
          const image = getRecipeImage(recipe) || 'https://lh3.googleusercontent.com/aida-public/AB6AXuA4co0x-7E71MrGGHmDDW2O-Ma7YB6UWTEI7TxpMcz4f8DuxQh6BJlTOgTeRit7f0NBS4qJLwYjmN4VGU1usYBLhxtPS4udPQk6HTTceajIBIZnhtK4wJ3YU0Ciu7ifJMrZWK3rnYFnhFOo3V0K464bVrmteNQvbmZPESIDBirFPvcFm68OwbjaRRRPnkzhGdH0lFVi8o2p6Bf9yzgW__2qVcAWzIlk3TxuHcsxP63h5X_C2K7h4_12nkgs7xKk09B5lYgM3pFYaSA';
          return (
            <article class="group relative flex flex-col overflow-hidden rounded-2xl border border-gray-200 bg-surface-light shadow-sm transition-all hover:-translate-y-1 hover:shadow-xl hover:shadow-primary/20 dark:border-gray-800 dark:bg-surface-dark">
              <div class="relative aspect-video w-full overflow-hidden">
                <div class="absolute inset-0 bg-cover bg-center transition-transform duration-700 group-hover:scale-110" style={`background-image: url("${image}");`}></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60"></div>
                <div class="absolute right-3 top-3 rounded-full bg-black/50 p-2 backdrop-blur-md transition-colors hover:bg-primary hover:text-black">
                  <span class="material-symbols-outlined block text-[20px] text-white group-hover:text-black">favorite</span>
                </div>
              </div>
              <div class="flex flex-1 flex-col p-5">
                <h3 class="mb-1 text-lg font-bold leading-tight group-hover:text-primary transition-colors">
                  <a href={`${baseUrl}/recipes/${recipe.slug}`}>{recipe.data.title}</a>
                </h3>
                <p class="mb-4 text-sm text-gray-500 line-clamp-2 dark:text-gray-400">{recipe.data.description || 'A delicious recipe generated by AI-Chef.'}</p>
                <div class="mt-auto flex items-center justify-between border-t border-gray-100 pt-4 dark:border-gray-800">
                  <div class="flex items-center gap-4 text-xs font-medium text-gray-500 dark:text-gray-400 font-mono">
                    <div class="flex items-center gap-1">
                      <span class="material-symbols-outlined text-[16px]">schedule</span>
                      <span>45m</span>
                    </div>
                  </div>
                  <div class="flex items-center gap-1 text-primary">
                    <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
                  </div>
                </div>
              </div>
            </article>
          );
        })}
      </div>
    </main>
  </div>
</Layout>
