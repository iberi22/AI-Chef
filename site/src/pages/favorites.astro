---
import Layout from '../layouts/Layout.astro';
const baseUrl = import.meta.env.BASE_URL;
---

<Layout title="My Favorite Recipes">
  <div class="min-h-screen w-full px-6 py-12 lg:px-10">
    <div class="mx-auto max-w-[1440px]">
      <div class="mb-10 flex items-center gap-4">
        <a href={baseUrl} class="flex size-10 items-center justify-center rounded-xl bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-gray-700 text-text-light dark:text-text-dark hover:bg-primary hover:text-black hover:border-primary transition-all shadow-sm">
            <span class="material-symbols-outlined">arrow_back</span>
        </a>
        <h1 class="font-display text-3xl font-bold text-text-light dark:text-text-dark">My Favorite Recipes</h1>
      </div>

      <div id="favorites-grid" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
        <!-- Content injected by JS -->
      </div>

      <div id="empty-state" class="hidden flex-col items-center justify-center py-20 text-center">
        <span class="material-symbols-outlined text-6xl text-gray-300 dark:text-gray-600 mb-4">favorite_border</span>
        <h3 class="text-xl font-bold text-text-light dark:text-text-dark mb-2">No favorites yet</h3>
        <p class="text-gray-500 dark:text-gray-400 mb-6">Start exploring and save your favorite recipes!</p>
        <a href={baseUrl} class="inline-flex h-10 items-center justify-center rounded-full bg-primary px-6 font-bold text-black shadow-neon transition-all hover:scale-105">
          Explore Recipes
        </a>
      </div>
    </div>
  </div>

  <script is:inline define:vars={{ baseUrl }}>
    async function renderFavorites() {
      const grid = document.getElementById('favorites-grid');
      const emptyState = document.getElementById('empty-state');
      const STORAGE_KEY = 'ai_chef_favorites';

      if (!grid || !emptyState) return;

      const favsStored = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

      if (favsStored.length === 0) {
        grid.classList.add('hidden');
        emptyState.classList.remove('hidden');
        emptyState.classList.add('flex');
        return;
      }

      // Fetch "Truth" data from index
      let allRecipes = [];
      try {
          const response = await fetch(`${baseUrl}/search-index.json`);
          allRecipes = await response.json();
      } catch (e) {
          console.error("Could not fetch search index", e);
          // Fallback to stored data if fetch fails
          allRecipes = favsStored;
      }

      // Filter the index for items that are in favorites
      // We look up by slug
      const favoriteRecipes = allRecipes.filter(r => favsStored.some(f => f.slug === r.slug));

      // If we couldn't find any (maybe network error), try to use stored data as fallback if it has title
      const recipesToRender = favoriteRecipes.length > 0 ? favoriteRecipes : favsStored.filter(f => f.title);

      if (recipesToRender.length === 0) {
         grid.classList.add('hidden');
         emptyState.classList.remove('hidden');
         emptyState.classList.add('flex');
         return;
      }

      grid.classList.remove('hidden');
      emptyState.classList.add('hidden');
      emptyState.classList.remove('flex');

      grid.innerHTML = recipesToRender.map(recipe => {
        const title = recipe.title || recipe.data?.title || recipe.slug;
        const slug = recipe.slug;
        const image = recipe.image || recipe.data?.image;
        const category = recipe.category || slug.split('/')[0];
        const recipeUrl = `${baseUrl}/dishes/${slug}`;

        return `
          <div class="group relative flex flex-col overflow-hidden rounded-2xl bg-surface-light dark:bg-surface-dark shadow-sm ring-1 ring-black/5 dark:ring-white/10 transition-all duration-300 hover:-translate-y-1 hover:shadow-neon hover:ring-primary/50">
            <a href="${recipeUrl}" class="absolute inset-0 z-0" aria-label="View recipe: ${title}"></a>

            <div class="aspect-[4/3] w-full overflow-hidden bg-gray-100 dark:bg-gray-800 relative pointer-events-none">
              ${image ?
                `<img src="${image}" alt="${title}" class="h-full w-full object-cover transition-transform duration-500 group-hover:scale-110" loading="lazy" />` :
                `<div class="flex h-full w-full items-center justify-center text-gray-300 dark:text-gray-600"><span class="material-symbols-outlined text-6xl">restaurant_menu</span></div>`
              }
              <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent opacity-0 transition-opacity duration-300 group-hover:opacity-100"></div>
              <div class="absolute top-3 right-3 z-20 pointer-events-auto">
                 <button class="fav-btn-page flex size-8 items-center justify-center rounded-full bg-white/90 backdrop-blur-sm text-red-500 shadow-sm transition-all hover:scale-110 active" data-slug="${slug}">
                   <span class="material-symbols-outlined text-[20px] fill-1">favorite</span>
                 </button>
              </div>
            </div>

            <div class="flex flex-1 flex-col p-5 pointer-events-none">
              <span class="mb-2 text-xs font-bold uppercase tracking-wider text-primary">${category}</span>
              <h3 class="font-display text-lg font-bold leading-tight text-text-light dark:text-text-dark group-hover:text-primary transition-colors">${title}</h3>
            </div>
          </div>
        `;
      }).join('');

      // Wire up remove buttons
      document.querySelectorAll('.fav-btn-page').forEach(btn => {
          btn.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();
              const slug = e.currentTarget.dataset.slug;
              const current = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
              const newFavs = current.filter(f => f.slug !== slug);
              localStorage.setItem(STORAGE_KEY, JSON.stringify(newFavs));
              // Re-render
              renderFavorites();
          });
      });
    }

    // Call immediately if DOM is ready, or wait
    if(document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', renderFavorites);
    } else {
        renderFavorites();
    }

    document.addEventListener('astro:page-load', renderFavorites);
  </script>
</Layout>
